# https://docs.github.com/zh/actions/get-started/quickstart actions文档

# 工作流名称：使用卷挂载部署
name: Deploy with Volume Mount

# 触发条件配置
on:
  # 当代码推送到 main 分支时触发
  push:
    branches: [main]
  
  # 允许在 GitHub Actions 页面手动触发此工作流
  workflow_dispatch:

# 工作流任务定义
jobs:
  # 部署任务
  deploy:
    # GitHub 官方提供的运行器
    runs-on: ubuntu-latest
    
    # 任务步骤定义
    steps:
      # 步骤1: 拉取仓库代码
      - name: Checkout
        # 使用官方的代码检出动作 (v4版本)
        uses: actions/checkout@v4

      # 步骤2: 安装依赖并构建 Astro 项目
      - name: Install and Build (Astro)
        # 使用官方的 Astro 构建动作 (v3版本)
        uses: withastro/action@v3
        # 注意: 这个动作会自动执行 npm install 和 npm run build
        # 构建产物会生成在 dist/ 目录

      # 步骤3: 上传构建文件到服务器
      - name: Upload Files to Server
        # 使用 SCP 动作进行文件传输
        uses: appleboy/scp-action@v0.1.6
        with:
          # 服务器 IP 地址 (从 GitHub Secrets 读取)
          host: ${{ secrets.SERVER_IP }}
          # SSH 用户名 (从 GitHub Secrets 读取)
          username: ${{ secrets.SSH_USERNAME }}
          # SSH 私钥 (从 GitHub Secrets 读取)
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # 源文件: 构建产生的所有文件
          source: "dist/*"
          # 目标路径: 服务器上的挂载目录
          target: "/cyjk/blog"
          # 注意: 这个目录会被挂载到 Nginx 容器的网页根目录

      # 步骤4: 启动/重启 Docker 容器
      - name: Start/Restart Container
        # 使用 SSH 动作在服务器上执行命令
        uses: appleboy/ssh-action@v1
        with:
          # 服务器连接信息 (同上一步)
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # 在服务器上执行的脚本命令
          script: |
           # 优雅重启：存在则重启，不存在则创建
            docker restart HRD-Blog || docker run -d \
            --name HRD-Blog \          # 容器名称
            -p 4321:80 \                # 端口映射：主机4321 → 容器80
            -v /cyjk/blog:/usr/share/nginx/html:ro \  # 卷挂载（只读）
            nginx:alpine                # 使用轻量级镜像